<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Ajouter un match</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }

        input,
        select,
        button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }

        .actions-group {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>

<body>
    <h1>Ajouter un match</h1>

    <!-- Formulaire Match -->
    <input type="date" id="date">
    <select id="equipe">
        <option>18A</option>
        <option>17</option>
        <option>18B</option>
    </select>
    <input type="text" id="adversaire" placeholder="Adversaire">
    <select id="lieu">
        <option>Domicile</option>
        <option>Ext√©rieur</option>
    </select>
    <select id="competition">
        <option>Phase</option>
        <option>Coupe</option>
        <option>Amical</option>
    </select>
    <input type="number" id="buts_gjpb" placeholder="Buts GJPB">
    <input type="number" id="buts_adv" placeholder="Buts Adverses">
    <select id="resultat">
        <option value="V">Victoire</option>
        <option value="N">Nul</option>
        <option value="D">D√©faite</option>
    </select>

    <!-- Buteurs -->
    <div class="actions-group">
        <label for="nbButeurs">Nombre de buteurs :</label>
        <input type="number" id="nbButeurs" min="0" max="10">
        <div id="buteurs-container"></div>
    </div>

    <!-- Passeurs -->
    <div class="actions-group">
        <label for="nbPasseurs">Nombre de passeurs :</label>
        <input type="number" id="nbPasseurs" min="0" max="10">
        <div id="passeurs-container"></div>
    </div>

    <button id="submitBtn">Enregistrer le match</button>
    <p id="resultatMessage"></p>

    <hr>
    <h2>Matchs enregistr√©s</h2>
    <table id="tableMatchs">
        <thead>
            <tr>
                <th>Date</th>
                <th>√âquipe</th>
                <th>Adversaire</th>
                <th>Lieu</th>
                <th>Comp√©tition</th>
                <th>Buts GJPB</th>
                <th>Buts Adv.</th>
                <th>R√©sultat</th>
                <th>Modifier</th>
                <th>Supprimer</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const SUPABASE_URL = 'https://lgnwgbctaqaeawzjnuqh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6...';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let joueurs = [];
        let matchEnCours = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Charger joueurs
            const { data: jdata, error: jerror } = await supabase.from('joueurs').select('nom');
            if (!jerror) joueurs = jdata.map(j => j.nom);

            document.getElementById('nbButeurs').addEventListener('input', () => genererChamps('buteurs-container', 'buteur'));
            document.getElementById('nbPasseurs').addEventListener('input', () => genererChamps('passeurs-container', 'passeur'));
            document.getElementById('submitBtn').addEventListener('click', soumettreMatch);

            chargerMatchs();
        });

        function genererChamps(containerId, prefix, valeurs = []) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const nbField = document.getElementById(`nb${prefix.charAt(0).toUpperCase() + prefix.slice(1)}s`);
            const nb = valeurs.length || parseInt(nbField.value) || 0;
            for (let i = 0; i < nb; i++) {
                const select = document.createElement('select'); select.name = `${prefix}_${i}`;
                joueurs.forEach(n => {
                    const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                    if (valeurs[i] === n) opt.selected = true;
                    select.appendChild(opt);
                });
                container.appendChild(select);
            }
        }

        async function soumettreMatch() {
            const matchData = {
                date: document.getElementById('date').value,
                equipe: document.getElementById('equipe').value,
                adversaire: document.getElementById('adversaire').value,
                lieu: document.getElementById('lieu').value,
                competition: document.getElementById('competition').value,
                buts_gjpb: parseInt(document.getElementById('buts_gjpb').value) || 0,
                buts_adv: parseInt(document.getElementById('buts_adv').value) || 0,
                resultat: document.getElementById('resultat').value
            };
            let matchId;
            if (matchEnCours) {
                // update match
                const { error: upErr } = await supabase.from('matchs').update(matchData).eq('id', matchEnCours);
                if (upErr) { alert('Erreur modification match'); console.error(upErr); return; }
                // delete old actions
                const { error: delErr } = await supabase.from('actions').delete().eq('match_id', matchEnCours);
                if (delErr) { alert('Erreur suppression anciennes actions'); console.error(delErr); return; }
                matchId = matchEnCours;
            } else {
                const { data: mdata, error: insErr } = await supabase.from('matchs').insert(matchData).select().single();
                if (insErr) { alert('Erreur ajout match'); console.error(insErr); return; } matchId = mdata.id;
            }
            // insert actions
            const actions = [];
            document.querySelectorAll('[name^="buteur_"]').forEach(el => actions.push({ match_id: matchId, joueur: el.value, type: 'Goal' }));
            document.querySelectorAll('[name^="passeur_"]').forEach(el => actions.push({ match_id: matchId, joueur: el.value, type: 'Assist' }));
            if (actions.length) { const { error: actErr } = await supabase.from('actions').insert(actions); if (actErr) { alert('Erreur ajout actions'); console.error(actErr); return; } }
            document.getElementById('resultatMessage').innerText = 'Match et actions enregistr√©s !';
            matchEnCours = null; document.getElementById('submitBtn').textContent = 'Enregistrer le match';
            chargerMatchs();
        }

        async function chargerMatchs() {
            const { data, error } = await supabase.from('matchs').select('*').order('date', { ascending: false });
            if (error) { console.error(error); return; } const tbody = document.querySelector('#tableMatchs tbody'); tbody.innerHTML = '';
            data.forEach(m => {
                const tr = document.createElement('tr');
                ['date', 'equipe', 'adversaire', 'lieu', 'competition', 'buts_gjpb', 'buts_adv', 'resultat'].forEach(key => {
                    const td = document.createElement('td'); td.textContent = key === 'date' ? m.date.slice(0, 10) : m[key]; tr.appendChild(td);
                });
                const eBtn = document.createElement('button'); eBtn.textContent = '‚úèÔ∏è'; eBtn.addEventListener('click', () => modifierMatch(m.id));
                const tdE = document.createElement('td'); tdE.appendChild(eBtn); tr.appendChild(tdE);
                const dBtn = document.createElement('button'); dBtn.textContent = 'üóëÔ∏è'; dBtn.addEventListener('click', () => supprimerMatch(m.id));
                const tdD = document.createElement('td'); tdD.appendChild(dBtn); tr.appendChild(tdD);
                tbody.appendChild(tr);
            });
        }

        async function supprimerMatch(id) { if (!confirm('Supprimer ce match¬†?')) return; const { error } = await supabase.from('matchs').delete().eq('id', id); if (error) { alert('Erreur suppression'); console.error(error); } chargerMatchs(); }

        async function modifierMatch(id) {
            console.log('modifierMatch id=', id);
            const { data: match, error: me } = await supabase.from('matchs').select('*').eq('id', id).single();
            if (me) { console.error(me); return; }
            document.getElementById('date').value = match.date.slice(0, 10);
            document.getElementById('equipe').value = match.equipe;
            document.getElementById('adversaire').value = match.adversaire;
            document.getElementById('lieu').value = match.lieu;
            document.getElementById('competition').value = match.competition;
            document.getElementById('buts_gjpb').value = match.buts_gjpb;
            document.getElementById('buts_adv').value = match.buts_adv;
            document.getElementById('resultat').value = match.resultat;
            const { data: acts, error: ae } = await supabase.from('actions').select('joueur,type').eq('match_id', id);
            if (ae) { console.error(ae); return; }
            const bu = acts.filter(a => a.type === 'Goal').map(a => a.joueur);
            const pa = acts.filter(a => a.type === 'Assist').map(a => a.joueur);
            document.getElementById('nbButeurs').value = bu.length; genererChamps('buteurs-container', 'buteur', bu);
            document.getElementById('nbPasseurs').value = pa.length; genererChamps('passeurs-container', 'passeur', pa);
            matchEnCours = id; document.getElementById('submitBtn').textContent = 'Modifier le match';
        }
    </script>
</body>

</html>