<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Ajouter un match</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 700px;
            margin: auto;
        }

        input,
        select,
        button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }

        .actions-group {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
    </style>
</head>

<body>
    <div id="formulaire">

        <h1>Ajouter un match !! </h1>

        <input type="date" id="date">
        <select id="equipe">
            <option>18A</option>
            <option>17</option>
            <option>18B</option>
        </select>
        <input type="text" id="adversaire" placeholder="Adversaire">
        <select id="lieu">
            <option>Domicile</option>
            <option>Ext√©rieur</option>
        </select>
        <select id="competition">
            <option>Phase</option>
            <option>Coupe</option>
            <option>Amical</option>
        </select>
        <input type="number" id="buts_gjpb" placeholder="Buts GJPB">
        <input type="number" id="buts_adv" placeholder="Buts adverses">
        <select id="resultat">
            <option value="V">Victoire</option>
            <option value="N">Nul</option>
            <option value="D">D√©faite</option>
        </select>

        <!-- Section buteurs -->
        <div class="actions-group">
            <label for="nbButeurs">Nombre de buteurs :</label>
            <input type="number" id="nbButeurs" min="0" max="14">
            <div id="buteurs-container"></div>
        </div>

        <!-- Section passeurs -->
        <div class="actions-group">
            <label for="nbPasseurs">Nombre de passeurs :</label>
            <input type="number" id="nbPasseurs" min="0" max="14">
            <div id="passeurs-container"></div>
        </div>

        <button onclick="soumettreMatch()">Enregistrer</button>
        <p id="resultatMessage"></p>

    </div>




    <h2>Matchs enregistr√©s</h2>
    <table border="1" style="width: 100%; border-collapse: collapse;" id="tableauMatchs">
        <thead>
            <tr>
                <th>Date</th>
                <th>√âquipe</th>
                <th>Adversaire</th>
                <th>Lieu</th>
                <th>Comp√©tition</th>
                <th>Score</th>
                <th>R√©sultat</th>
                <th>Buteurs</th>
                <th>Passeurs</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <script>
        const supabase = window.supabase.createClient(
            'https://lgnwgbctaqaeawzjnuqh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbndnYmN0YXFhZWF3empudXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjYzNjUsImV4cCI6MjA2OTQwMjM2NX0.E0ug5jpRQVh55aq1ewToqol7h7aRPkg7YvwbKpQtVHo'
        );

        let joueurs = [];

        document.addEventListener("DOMContentLoaded", async () => {
            const { data, error } = await supabase.from("joueurs").select("nom");
            if (error) {
                document.getElementById("resultatMessage").innerText = "Erreur chargement joueurs";
                return;
            }
            joueurs = data.map(j => j.nom);
            document.getElementById("nbButeurs").addEventListener("change", () => genererChamps("buteurs-container", "buteur"));
            document.getElementById("nbPasseurs").addEventListener("change", () => genererChamps("passeurs-container", "passeur"));
            await chargerMatchs();
        });



        function genererChamps(containerId, prefix, count = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // reset

            const nb = count !== null ? count : document.getElementById(`nb${prefix[0].toUpperCase() + prefix.slice(1)}s`).value;

            for (let i = 0; i < nb; i++) {
                const select = document.createElement('select');
                select.name = `${prefix}_${i}`;
                select.id = `${prefix}_${i}`;  // ‚ö†Ô∏è important
                joueurs.forEach(nom => {
                    const option = document.createElement('option');
                    option.value = nom;
                    option.textContent = nom;
                    select.appendChild(option);
                });
                container.appendChild(select);
            }
        }







        async function soumettreMatch() {
            const date = document.getElementById("date").value;
            const equipe = document.getElementById("equipe").value;
            const adversaire = document.getElementById("adversaire").value;
            const lieu = document.getElementById("lieu").value;
            const competition = document.getElementById("competition").value;
            const buts_gjpb = parseInt(document.getElementById("buts_gjpb").value);
            const buts_adv = parseInt(document.getElementById("buts_adv").value);
            const resultat = document.getElementById("resultat").value;

            // 1. Insertion du match
            const { data: match, error: errMatch } = await supabase
                .from("matchs")
                .insert({
                    date, equipe, adversaire, lieu, competition,
                    buts_gjpb, buts_adv, resultat
                })
                .select()
                .single();

            if (errMatch) {
                console.error("Erreur ajout match :", errMatch);
                document.getElementById("resultatMessage").innerText = "Erreur ajout match.";
                return;
            }

            const match_id = match.id;

            // 2. R√©cup√©ration des buteurs et passeurs
            const buteurs = Array.from(document.querySelectorAll('#buteurs-container select')).map(s => s.value);
            const passeurs = Array.from(document.querySelectorAll('#passeurs-container select')).map(s => s.value);

            const actions = [
                ...buteurs.map(joueur => ({ match_id, joueur, type: 'Goal' })),
                ...passeurs.map(joueur => ({ match_id, joueur, type: 'Assist' }))
            ];

            if (actions.length > 0) {
                const { error: errActions } = await supabase.from("actions").insert(actions);
                if (errActions) {
                    console.error("Erreur ajout actions :", errActions);
                    document.getElementById("resultatMessage").innerText = "Match OK mais erreur actions.";
                    return;
                }
            }

            document.getElementById("resultatMessage").innerText = "Match et actions enregistr√©s avec succ√®s ! ‚úÖ";
        }


        async function chargerMatchs() {
            const { data: matchs, error } = await supabase
                .from('matchs')
                .select('*, actions(*)')
                .order('date', { ascending: false });

            if (error) {
                console.error("‚ùå Erreur chargement matchs :", error);
                return;
            }

            const tableau = document.getElementById('tableauMatchs');
            tableau.innerHTML = ''; // reset

            matchs.forEach(match => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${match.date}</td>
            <td>${match.equipe}</td>
            <td>${match.adversaire}</td>
            <td>${match.lieu}</td>
            <td>${match.competition}</td>
            <td>${match.buts_gjpb} - ${match.buts_adv}</td>
            <td>${match.resultat}</td>
            <td>
                <button class="modifier">‚úèÔ∏è</button>
                <button class="supprimer">üóëÔ∏è</button>
            </td>
        `;

                // üìù Bouton modifier
                const btnModifier = tr.querySelector('.modifier');
                btnModifier.addEventListener('click', () => {
                    console.log("üìù Modification demand√©e pour :", match);

                    // Remplir les champs simples
                    document.getElementById('date').value = match.date;
                    document.getElementById('equipe').value = match.equipe;
                    document.getElementById('adversaire').value = match.adversaire;
                    document.getElementById('lieu').value = match.lieu;
                    document.getElementById('competition').value = match.competition;
                    document.getElementById('buts_gjpb').value = match.buts_gjpb;
                    document.getElementById('buts_adv').value = match.buts_adv;
                    document.getElementById('resultat').value = match.resultat;

                    // Stocker l‚ÄôID du match dans le formulaire pour l‚Äô√©tape suivante
                    document.getElementById('formulaire').dataset.matchId = match.id;

                    console.log("‚úÖ Champs remplis pour modification !");
                });

                // üóëÔ∏è Bouton supprimer (facultatif, √† compl√©ter)
                const btnSupprimer = tr.querySelector('.supprimer');
                btnSupprimer.addEventListener('click', async () => {
                    const confirmDelete = confirm("Supprimer ce match ?");
                    if (!confirmDelete) return;

                    const { error: deleteError } = await supabase
                        .from('matchs')
                        .delete()
                        .eq('id', match.id);

                    if (deleteError) {
                        console.error("‚ùå Erreur suppression :", deleteError);
                        alert("Erreur lors de la suppression.");
                    } else {
                        console.log("‚úÖ Match supprim√©");
                        chargerMatchs(); // rafra√Æchir la liste
                    }
                });

                tableau.appendChild(tr);
            });
        }


        //     async function chargerMatchs() {
        //         const { data: matchs, error } = await supabase
        //             .from('matchs')
        //             .select('*, actions(*)')
        //             .order('date', { ascending: false });

        //         if (error) {
        //             console.error("Erreur chargement matchs :", error);
        //             return;
        //         }

        //         const tableau = document.getElementById('tableauMatchs');
        //         tableau.innerHTML = `
        //     <tr>
        //         <th>Date</th>
        //         <th>√âquipe</th>
        //         <th>Adversaire</th>
        //         <th>Score</th>
        //         <th>Comp√©tition</th>
        //         <th>Buteurs</th>
        //         <th>Passeurs</th>
        //         <th>Actions</th>
        //     </tr>
        // `;

        //         matchs.forEach(match => {
        //             const ligne = document.createElement('tr');

        //             const buteurs = match.actions
        //                 ?.filter(a => a.type === 'but')
        //                 .map(a => a.joueur)
        //                 .join(', ') || '';

        //             const passeurs = match.actions
        //                 ?.filter(a => a.type === 'passe')
        //                 .map(a => a.joueur)
        //                 .join(', ') || '';

        //             ligne.innerHTML = `
        //         <td>${match.date}</td>
        //         <td>${match.equipe}</td>
        //         <td>${match.adversaire}</td>
        //         <td>${match.buts_gjpb} - ${match.buts_adv}</td>
        //         <td>${match.competition}</td>
        //         <td>${buteurs}</td>
        //         <td>${passeurs}</td>
        //         <td>
        //             <button class="modifier">‚úèÔ∏è</button>
        //             <button class="supprimer">üóëÔ∏è</button>
        //         </td>
        //     `;

        //             // Ajouter la ligne au tableau
        //             tableau.appendChild(ligne);

        //             // === üéØ BOUTON MODIFIER ===
        //             const btnModifier = ligne.querySelector('.modifier');
        //             btnModifier.addEventListener('click', () => {
        //                 console.log("üìù Modification demand√©e pour :", match);

        //                 // Remplir les champs simples
        //                 document.getElementById('date').value = match.date;
        //                 document.getElementById('equipe').value = match.equipe;
        //                 document.getElementById('adversaire').value = match.adversaire;
        //                 document.getElementById('lieu').value = match.lieu;
        //                 document.getElementById('competition').value = match.competition;
        //                 document.getElementById('buts_gjpb').value = match.buts_gjpb;
        //                 document.getElementById('buts_adv').value = match.buts_adv;
        //                 document.getElementById('resultat').value = match.resultat;

        //                 // Stocker l‚ÄôID du match en cours de modification
        //                 document.getElementById('formulaire').dataset.matchId = match.id;

        //                 console.log("‚úÖ Champs remplis pour modification !");
        //             });


        //             // === üóëÔ∏è BOUTON SUPPRIMER (facultatif ici, si d√©j√† pr√©sent) ===
        //             const btnSupprimer = ligne.querySelector('.supprimer');
        //             btnSupprimer.addEventListener('click', () => {
        //                 supprimerMatch(match.id);
        //             });
        //         });
        //     }





        async function supprimerMatch(id) {
            const confirmation = confirm("Supprimer ce match ? Cette action est d√©finitive.");
            if (!confirmation) return;

            // Supprimer d'abord les actions li√©es
            const { error: errorActions } = await supabase.from("actions").delete().eq("match_id", id);
            if (errorActions) {
                alert("Erreur suppression des buteurs/passeurs");
                console.error(errorActions);
                return;
            }

            // Supprimer le match
            const { error } = await supabase.from("matchs").delete().eq("id", id);
            if (error) {
                alert("Erreur suppression du match");
                console.error(error);
                return;
            }

            alert("Match supprim√© !");
            await chargerMatchs(); // Recharger le tableau
        }


        function modifierMatch(match) {
            console.log("Modification demand√©e pour :", match);

            // √âtape 1 : Remplir les champs du match
            document.getElementById("date").value = match.date;
            document.getElementById("equipe").value = match.equipe;
            document.getElementById("adversaire").value = match.adversaire;
            document.getElementById("lieu").value = match.lieu;
            document.getElementById("competition").value = match.competition;
            document.getElementById("buts_gjpb").value = match.buts_gjpb;
            document.getElementById("buts_adv").value = match.buts_adv;
            document.getElementById("resultat").value = match.resultat;

            // √âtape 2 : Ajouter l'attribut data-match-id sur le formulaire
            document.getElementById("formulaire").dataset.matchId = match.id;

            console.log("‚úÖ Champs remplis pour modification !");

            // √âtape 3 : Calculer le nombre de buteurs et passeurs
            const buteurs = match.actions.filter(a => a.type === "Goal");
            const passeurs = match.actions.filter(a => a.type === "Assist");

            // √âtape 4 : D√©finir le nombre dans les inputs
            document.getElementById("nbButeurs").value = buteurs.length;
            document.getElementById("nbPasseurs").value = passeurs.length;

            console.log("üõ†Ô∏è G√©n√©ration des champs...");
            genererChamps("buteurs-container", "buteur", match.actions.filter(a => a.type === "Goal").length);
            genererChamps("passeurs-container", "passeur", match.actions.filter(a => a.type === "Assist").length);

            setTimeout(() => {
                console.log("‚è≥ Appel de remplirChampsActions...");
                remplirChampsActions(match.actions);
            }, 0);

        }





        function remplirChampsActions(actions) {
            console.log("üîÅ remplissage des selects...");

            const buts = actions.filter(a => a.type === "Goal");
            const passes = actions.filter(a => a.type === "Assist");

            buts.forEach((a, i) => {
                const select = document.getElementById(`buteur_${i}`);
                console.log(`Remplissage buteur ${i} -> ${a.joueur} -> select=`, select);
                if (select) select.value = a.joueur;
                else console.warn(`‚ùå Champ select introuvable pour buteur ${i}`);
            });

            passes.forEach((a, i) => {
                const select = document.getElementById(`passeur_${i}`);
                console.log(`Remplissage passeur ${i} -> ${a.joueur} -> select=`, select);
                if (select) select.value = a.joueur;
                else console.warn(`‚ùå Champ select introuvable pour passeur ${i}`);
            });
        }







    </script>

</body>

</html>