<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Admin — GJPB Stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: auto;
        }

        h1,
        h2 {
            margin: 0 0 12px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .row>* {
            width: 100%;
        }

        input,
        select,
        button {
            padding: 8px;
            font-size: 14px;
        }

        button {
            cursor: pointer;
        }

        .group {
            margin-top: 18px;
            padding-top: 14px;
            border-top: 1px solid #ddd;
        }

        #msg {
            margin: 8px 0;
            min-height: 20px;
            color: #0a7d25;
        }

        #msg.err {
            color: #b00020;
        }

        .table-wrap {
            overflow-x: auto;
            margin-top: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }

        td.actions button {
            margin-right: 6px;
        }

        @media (max-width: 640px) {
            .row {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 6px;
            }
        }
    </style>
</head>

<body>
    <div style="background-color: #f9f7e4; padding: 10px; text-align: center;">
        <h1>Admin — Ajouter / Modifier un match !!!</h1>
    </div>


    <form id="form" data-match-id="">
        <div class="row">
            <div class="group">Date :
                <input type="date" id="date" />
            </div>
            <div class="group">Équipe :
                <select id="equipe">
                    <option value="18A">18A</option>
                    <option value="17">17</option>
                    <option value="18B">18B</option>
                </select>
            </div>
            <div class="group">Adversaire :
                <input type="text" id="adversaire" placeholder="Adversaire" />
            </div>
            <div class="group">Lieu :
                <select id="lieu">
                    <option value="DOM">DOM</option>
                    <option value="EXT">EXT</option>
                </select>
            </div>
            <div class="group">Compétition :
                <select id="competition">
                    <option value="Phase 1">Phase 1</option>
                    <option value="Phase 2">Phase 2</option>
                    <option value="Phase 3">Phase 3</option>
                    <option value="Amical">Amical</option>
                    <option value="Coupe">Coupe</option>
                </select>
            </div>
            <div class="group">Résultat :
                <select id="resultat">
                    <option value="V">Victoire</option>
                    <option value="N">Nul</option>
                    <option value="D">Défaite</option>
                </select>
            </div>
            <div class="group">Score :
                <input type="number" id="buts_gjpb" placeholder="GJPB" min="0" style="width:80px;" />
                -
                <input type="number" id="buts_adv" placeholder="Adversaire" min="0" style="width:80px;" />
            </div>

        </div>

        <div class="group">
            <label for="nbButeurs"><b>Nombre de buteurs</b></label>
            <input type="number" id="nbButeurs" min="0" max="14" value="0" />
            <div id="buteurs-container"></div>
        </div>

        <div class="group">
            <label for="nbPasseurs"><b>Nombre de passeurs</b></label>
            <input type="number" id="nbPasseurs" min="0" max="14" value="0" />
            <div id="passeurs-container"></div>
        </div>

        <div class="group" style="text-align: center;">
            <button id="saveBtn">Enregistrer</button>
            <button id="resetBtn" type="button" style="margin-left:8px; background-color: black; color: white;">Réinitialiser</button>
            <div id="msg"></div>
        </div>
    </form>
    <br><br><br>

    <h2 style="text-align: center;">⚽Matchs enregistrés⚽</h2>
    <div class="table-wrap">
        <table id="matchsTable">
            <thead>
                <tr style="background-color: gray;">
                    <th>Actions</th>
                    <th>Date</th>
                    <th>Équipe</th>
                    <th>Adversaire</th>
                    <th>Lieu</th>
                    <th>Compétition</th>
                    <th>Score</th>
                    <th>Résultat</th>
                    <th>Buteurs</th>
                    <th>Passeurs</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // ⚙️ REMPLACE ICI PAR TES VALEURS (Project Settings → API)
        const SUPABASE_URL = 'https://lgnwgbctaqaeawzjnuqh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbndnYmN0YXFhZWF3empudXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjYzNjUsImV4cCI6MjA2OTQwMjM2NX0.E0ug5jpRQVh55aq1ewToqol7h7aRPkg7YvwbKpQtVHo';

        // Client Supabase (pas de session persistée pour éviter les surprises anon/auth)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: false, autoRefreshToken: false }
        });

        // État
        let joueurs = []; // liste de noms

        // Utils DOM
        const $ = (sel) => document.querySelector(sel);
        const msg = (t, err = false) => { const el = $('#msg'); el.textContent = t || ''; el.className = err ? 'err' : ''; };

        // Crée N selects alimentés par 'joueurs' dans un container
        function genererChamps(containerId, prefix, count) {
            const cont = document.getElementById(containerId);
            cont.innerHTML = '';
            const n = Number(count) || 0;
            for (let i = 0; i < n; i++) {
                const sel = document.createElement('select');
                sel.id = `${prefix}_${i}`;
                sel.name = `${prefix}_${i}`;
                // options
                joueurs.forEach(nom => {
                    const opt = document.createElement('option');
                    opt.value = nom;
                    opt.textContent = nom;
                    sel.appendChild(opt);
                });
                cont.appendChild(sel);
            }
        }

        // Charge joueurs (SELECT sur table 'joueurs')
        async function chargerJoueurs() {
            const { data, error } = await supabase.from('joueurs').select('nom').order('nom', { ascending: true });
            if (error) { msg("Erreur chargement joueurs : " + error.message, true); return; }
            joueurs = (data || []).map(j => j.nom);
            if (!joueurs.length) {
                msg("⚠️ Aucun joueur trouvé (vérifie RLS/roles sur 'joueurs').", true);
            }
        }

        // Enregistre ou met à jour un match + (ré)insère ses actions
        async function enregistrerMatch() {
            const form = document.getElementById('form');
            const matchId = form.dataset.matchId || null;

            const match = {
                date: $('#date').value,
                equipe: $('#equipe').value,
                adversaire: $('#adversaire').value,
                lieu: $('#lieu').value,
                competition: $('#competition').value,
                buts_gjpb: Number($('#buts_gjpb').value || 0),
                buts_adv: Number($('#buts_adv').value || 0),
                resultat: $('#resultat').value
            };

            if (!match.date) { msg("La date est obligatoire.", true); return; }
            if (!match.equipe || !match.adversaire) { msg("Équipe et adversaire sont obligatoires.", true); return; }

            // Récupère listes buteurs/passeurs
            const actions = [];
            document.querySelectorAll('#buteurs-container select').forEach(s => actions.push({ type: 'Goal', joueur: s.value }));
            document.querySelectorAll('#passeurs-container select').forEach(s => actions.push({ type: 'Assist', joueur: s.value }));

            try {
                let id = matchId;

                if (matchId) {
                    const { error: upErr } = await supabase.from('matchs').update(match).eq('id', matchId);
                    if (upErr) throw upErr;
                    // delete anciennes actions
                    const { error: delErr } = await supabase.from('actions').delete().eq('match_id', matchId);
                    if (delErr) throw delErr;
                } else {
                    const { data: inserted, error: insErr } = await supabase.from('matchs').insert(match).select().single();
                    if (insErr) throw insErr;
                    id = inserted.id;
                }

                // (ré)insère actions si présentes
                if (actions.length) {
                    const payload = actions.map(a => ({ match_id: id, joueur: a.joueur, type: a.type }));
                    const { error: actErr } = await supabase.from('actions').insert(payload);
                    if (actErr) throw actErr;
                }

                msg(matchId ? "Match modifié ✅" : "Match ajouté ✅");
                form.dataset.matchId = '';
                form.reset();
                $('#buteurs-container').innerHTML = '';
                $('#passeurs-container').innerHTML = '';
                await chargerMatchs();
            } catch (e) {
                console.error(e);
                msg("Erreur enregistrement : " + (e.message || e), true);
            }
        }

        // Charge et affiche les matchs
        async function chargerMatchs() {
            const { data, error } = await supabase
                .from('matchs')
                .select('*, actions(*)')
                .order('date', { ascending: false });

            const tbody = document.querySelector('#matchsTable tbody');
            tbody.innerHTML = '';

            if (error) {
                console.error(error);
                msg("Erreur chargement matchs : " + error.message, true);
                return;
            }
            (data || []).forEach(m => {
                const buts = (m.actions || []).filter(a => a.type === 'Goal').map(a => a.joueur).join(', ');
                const pas = (m.actions || []).filter(a => a.type === 'Assist').map(a => a.joueur).join(', ');

                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="actions">
            <button data-id="${m.id}" class="edit">✏️</button>
            <button data-id="${m.id}" class="del">🗑️</button>
          </td>      
          <td>${m.date || ''}</td>
          <td>${m.equipe || ''}</td>
          <td>${m.adversaire || ''}</td>
          <td>${m.lieu || ''}</td>
          <td>${m.competition || ''}</td>
          <td>${Number(m.buts_gjpb) || 0} - ${Number(m.buts_adv) || 0}</td>
          <td>${m.resultat || ''}</td>
          <td>${buts}</td>
          <td>${pas}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Remplit le formulaire pour édition
        async function chargerMatchDansForm(id) {
            const { data: m, error } = await supabase
                .from('matchs')
                .select('*, actions(*)')
                .eq('id', id)
                .single();
            if (error) { msg("Erreur chargement du match.", true); return; }

            const form = document.getElementById('form');
            form.dataset.matchId = m.id;

            $('#date').value = m.date || '';
            $('#equipe').value = m.equipe || '18A';
            $('#adversaire').value = m.adversaire || '';
            $('#lieu').value = m.lieu || 'DOM';
            $('#competition').value = m.competition || 'Phase 1';
            $('#buts_gjpb').value = Number(m.buts_gjpb) || 0;
            $('#buts_adv').value = Number(m.buts_adv) || 0;
            $('#resultat').value = m.resultat || 'V';

            const buteurs = (m.actions || []).filter(a => a.type === 'Goal').map(a => a.joueur);
            const passeurs = (m.actions || []).filter(a => a.type === 'Assist').map(a => a.joueur);

            $('#nbButeurs').value = buteurs.length;
            $('#nbPasseurs').value = passeurs.length;

            genererChamps('buteurs-container', 'buteur', buteurs.length);
            genererChamps('passeurs-container', 'passeur', passeurs.length);

            // Applique les valeurs
            buteurs.forEach((nom, i) => { const sel = document.getElementById(`buteur_${i}`); if (sel) sel.value = nom; });
            passeurs.forEach((nom, i) => { const sel = document.getElementById(`passeur_${i}`); if (sel) sel.value = nom; });

            msg("Mode édition activé (modifie puis clique Enregistrer).");
        }

        // Supprime un match (+ actions via FK logique — ici on supprime explicitement les actions d’abord)
        async function supprimerMatch(id) {
            if (!confirm('Supprimer ce match ?')) return;
            const e1 = await supabase.from('actions').delete().eq('match_id', id);
            if (e1.error) { msg("Erreur suppression actions: " + e1.error.message, true); return; }
            const e2 = await supabase.from('matchs').delete().eq('id', id);
            if (e2.error) { msg("Erreur suppression match: " + e2.error.message, true); return; }
            msg("Match supprimé ✅");
            chargerMatchs();
        }

        // Listeners init
        document.addEventListener('DOMContentLoaded', async () => {
            // écouteurs dynamique pour nb buteurs/passeurs
            document.getElementById('nbButeurs').addEventListener('input', e => {
                genererChamps('buteurs-container', 'buteur', e.target.value);
            });
            document.getElementById('nbPasseurs').addEventListener('input', e => {
                genererChamps('passeurs-container', 'passeur', e.target.value);
            });

            document.getElementById('saveBtn').addEventListener('click', enregistrerMatch);
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('form').reset();
                document.getElementById('form').dataset.matchId = '';
                document.getElementById('buteurs-container').innerHTML = '';
                document.getElementById('passeurs-container').innerHTML = '';
                msg('');
            });

            // Délégation d’événements pour les boutons du tableau
            document.getElementById('matchsTable').addEventListener('click', (ev) => {
                const btn = ev.target.closest('button');
                if (!btn) return;
                const id = btn.dataset.id;
                if (btn.classList.contains('edit')) chargerMatchDansForm(id);
                if (btn.classList.contains('del')) supprimerMatch(id);
            });

            // Charge données
            await chargerJoueurs();   // alimente les selects dynamiques
            await chargerMatchs();    // affiche le tableau
        });
    </script>
</body>

</html>