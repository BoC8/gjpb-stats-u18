<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Ajouter un match</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 700px;
            margin: auto;
        }

        input,
        select,
        button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }

        .actions-group {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
    </style>
</head>

<body>

    <h1>Ajouter un match !!</h1>

    <input type="date" id="date">
    <select id="equipe">
        <option>18A</option>
        <option>17</option>
        <option>18B</option>
    </select>
    <input type="text" id="adversaire" placeholder="Adversaire">
    <select id="lieu">
        <option>Domicile</option>
        <option>Ext√©rieur</option>
    </select>
    <select id="competition">
        <option>Phase</option>
        <option>Coupe</option>
        <option>Amical</option>
    </select>
    <input type="number" id="buts_gjpb" placeholder="Buts GJPB">
    <input type="number" id="buts_adv" placeholder="Buts adverses">
    <select id="resultat">
        <option value="V">Victoire</option>
        <option value="N">Nul</option>
        <option value="D">D√©faite</option>
    </select>

    <!-- Section buteurs -->
    <div class="actions-group">
        <label for="nbButeurs">Nombre de buteurs :</label>
        <input type="number" id="nbButeurs" min="0" max="14">
        <div id="buteurs-container"></div>
    </div>

    <!-- Section passeurs -->
    <div class="actions-group">
        <label for="nbPasseurs">Nombre de passeurs :</label>
        <input type="number" id="nbPasseurs" min="0" max="14">
        <div id="passeurs-container"></div>
    </div>

    <button onclick="soumettreMatch()">Enregistrer</button>
    <p id="resultatMessage"></p>




    <h2>Matchs enregistr√©s</h2>
    <table border="1" style="width: 100%; border-collapse: collapse;" id="tableauMatchs">
        <thead>
            <tr>
                <th>Date</th>
                <th>√âquipe</th>
                <th>Adversaire</th>
                <th>Lieu</th>
                <th>Comp√©tition</th>
                <th>Score</th>
                <th>R√©sultat</th>
                <th>Buteurs</th>
                <th>Passeurs</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <script>
        const supabase = window.supabase.createClient(
            'https://lgnwgbctaqaeawzjnuqh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbndnYmN0YXFhZWF3empudXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjYzNjUsImV4cCI6MjA2OTQwMjM2NX0.E0ug5jpRQVh55aq1ewToqol7h7aRPkg7YvwbKpQtVHo'
        );

        let joueurs = [];

        document.addEventListener("DOMContentLoaded", async () => {
            const { data, error } = await supabase.from("joueurs").select("nom");
            if (error) {
                document.getElementById("resultatMessage").innerText = "Erreur chargement joueurs";
                return;
            }
            joueurs = data.map(j => j.nom);
            document.getElementById("nbButeurs").addEventListener("change", () => genererChamps("buteurs-container", "buteur"));
            document.getElementById("nbPasseurs").addEventListener("change", () => genererChamps("passeurs-container", "passeur"));
            await chargerMatchs();
        });



        function genererChamps(containerId, prefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const nb = document.getElementById(`nb${prefix[0].toUpperCase() + prefix.slice(1)}s`).value;

            for (let i = 0; i < nb; i++) {
                const select = document.createElement('select');
                joueurs.forEach(joueur => {
                    const option = document.createElement('option');
                    option.value = joueur;
                    option.textContent = joueur;
                    select.appendChild(option);
                });
                container.appendChild(select);
            }
        }



        async function soumettreMatch() {
            const date = document.getElementById("date").value;
            const equipe = document.getElementById("equipe").value;
            const adversaire = document.getElementById("adversaire").value;
            const lieu = document.getElementById("lieu").value;
            const competition = document.getElementById("competition").value;
            const buts_gjpb = parseInt(document.getElementById("buts_gjpb").value);
            const buts_adv = parseInt(document.getElementById("buts_adv").value);
            const resultat = document.getElementById("resultat").value;

            // 1. Insertion du match
            const { data: match, error: errMatch } = await supabase
                .from("matchs")
                .insert({
                    date, equipe, adversaire, lieu, competition,
                    buts_gjpb, buts_adv, resultat
                })
                .select()
                .single();

            if (errMatch) {
                console.error("Erreur ajout match :", errMatch);
                document.getElementById("resultatMessage").innerText = "Erreur ajout match.";
                return;
            }

            const match_id = match.id;

            // 2. R√©cup√©ration des buteurs et passeurs
            const buteurs = Array.from(document.querySelectorAll('#buteurs-container select')).map(s => s.value);
            const passeurs = Array.from(document.querySelectorAll('#passeurs-container select')).map(s => s.value);

            const actions = [
                ...buteurs.map(joueur => ({ match_id, joueur, type: 'Goal' })),
                ...passeurs.map(joueur => ({ match_id, joueur, type: 'Assist' }))
            ];

            if (actions.length > 0) {
                const { error: errActions } = await supabase.from("actions").insert(actions);
                if (errActions) {
                    console.error("Erreur ajout actions :", errActions);
                    document.getElementById("resultatMessage").innerText = "Match OK mais erreur actions.";
                    return;
                }
            }

            document.getElementById("resultatMessage").innerText = "Match et actions enregistr√©s avec succ√®s ! ‚úÖ";
        }



        async function chargerMatchs() {
            const table = document.querySelector("#tableauMatchs tbody");
            table.innerHTML = ""; // R√©initialiser le tableau

            // R√©cup√©ration de tous les matchs
            const { data: matchs, error: errMatchs } = await supabase.from("matchs").select("*");
            if (errMatchs) {
                console.error("Erreur chargement matchs :", errMatchs);
                return;
            }

            for (const match of matchs) {
                // R√©cup√©rer les actions (buteurs et passeurs) li√©es √† ce match
                const { data: actions, error: errActions } = await supabase
                    .from("actions")
                    .select("joueur, type")
                    .eq("match_id", match.id);

                const buteurs = actions?.filter(a => a.type === "Goal").map(a => a.joueur).join(", ") || "";
                const passeurs = actions?.filter(a => a.type === "Assist").map(a => a.joueur).join(", ") || "";

                const tr = document.createElement("tr");

                console.log("match.id =", match.id, typeof match.id);

                // Utiliser les backticks pour permettre l‚Äôinjection dynamique
                tr.innerHTML = `
                <td>${match.date}</td>
                <td>${match.equipe}</td>
                <td>${match.adversaire}</td>
                <td>${match.lieu}</td>
                <td>${match.competition}</td>
                <td>${match.buts_gjpb} - ${match.buts_adv}</td>
                <td>${match.resultat}</td>
                <td>${buteurs}</td>
                <td>${passeurs}</td>
                <td>
                    <button onclick='modifierMatch("${match.id}")'>‚úèÔ∏è</button>
                    <button onclick='supprimerMatch("${match.id}")'>üóëÔ∏è</button>
                </td>
                `;

                table.appendChild(tr);
            }
        }




        async function supprimerMatch(id) {
            const confirmation = confirm("Supprimer ce match ? Cette action est d√©finitive.");
            if (!confirmation) return;

            // Supprimer d'abord les actions li√©es
            const { error: errorActions } = await supabase.from("actions").delete().eq("match_id", id);
            if (errorActions) {
                alert("Erreur suppression des buteurs/passeurs");
                console.error(errorActions);
                return;
            }

            // Supprimer le match
            const { error } = await supabase.from("matchs").delete().eq("id", id);
            if (error) {
                alert("Erreur suppression du match");
                console.error(error);
                return;
            }

            alert("Match supprim√© !");
            await chargerMatchs(); // Recharger le tableau
        }



        async function modifierMatch(id) {
            matchEnCoursId = id;

            // 1. Charger les donn√©es du match
            const { data: match, error: err1 } = await supabase.from("matchs").select("*").eq("id", id).single();
            if (err1 || !match) {
                alert("Erreur chargement du match");
                return;
            }

            // 2. Pr√©-remplir les champs du formulaire
            document.getElementById("date").value = match.date;
            document.getElementById("equipe").value = match.equipe;
            document.getElementById("adversaire").value = match.adversaire;
            document.getElementById("lieu").value = match.lieu;
            document.getElementById("competition").value = match.competition;
            document.getElementById("buts_gjpb").value = match.buts_gjpb;
            document.getElementById("buts_adv").value = match.buts_adv;
            document.getElementById("resultat").value = match.resultat;

            // 3. Charger les actions li√©es √† ce match
            const { data: actions, error: err2 } = await supabase
                .from("actions")
                .select("joueur, type")
                .eq("match_id", id);

            if (err2) {
                alert("Erreur chargement des actions");
                return;
            }

            const buteurs = actions.filter(a => a.type === "Goal").map(a => a.joueur);
            const passeurs = actions.filter(a => a.type === "Assist").map(a => a.joueur);

            // 4. Remplir le formulaire dynamique des buteurs/passeurs
            document.getElementById("nbButeurs").value = buteurs.length;
            document.getElementById("nbPasseurs").value = passeurs.length;

            // Recr√©e les champs <select>
            genererChamps("buteurs-container", "buteur");
            genererChamps("passeurs-container", "passeur");

            // Ins√®re les valeurs dans les <select>
            buteurs.forEach((nom, i) => {
                const select = document.querySelector(`[name="buteur_${i}"]`);
                if (select) select.value = nom;
            });

            passeurs.forEach((nom, i) => {
                const select = document.querySelector(`[name="passeur_${i}"]`);
                if (select) select.value = nom;
            });

            // Scroll en haut du formulaire pour bien voir
            window.scrollTo({ top: 0, behavior: "smooth" });
        }



    </script>

</body>

</html>