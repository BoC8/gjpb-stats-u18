<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Ajouter un match</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }

        input,
        select,
        button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }

        .actions-group {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }

        .inline {
            display: inline-block;
            width: 48%;
            margin-right: 2%;
        }
    </style>
</head>

<body>

    <h1>Ajouter un match</h1>

    <!-- Formulaire Match -->
    <input type="date" id="date">
    <select id="equipe">
        <option>18A</option>
        <option>17</option>
        <option>18B</option>
    </select>
    <input type="text" id="adversaire" placeholder="Adversaire">
    <select id="lieu">
        <option>Domicile</option>
        <option>Ext√©rieur</option>
    </select>
    <select id="competition">
        <option>Phase</option>
        <option>Coupe</option>
        <option>Amical</option>
    </select>
    <input type="number" id="buts_gjpb" placeholder="Buts GJPB">
    <input type="number" id="buts_adv" placeholder="Buts adverses">
    <select id="resultat">
        <option value="V">Victoire</option>
        <option value="N">Nul</option>
        <option value="D">D√©faite</option>
    </select>

    <!-- Buteurs -->
    <div class="actions-group">
        <label for="nbButeurs">Nombre de buteurs :</label>
        <input type="number" id="nbButeurs" min="0" max="10">
        <div id="buteurs-container"></div>
    </div>

    <!-- Passeurs -->
    <div class="actions-group">
        <label for="nbPasseurs">Nombre de passeurs :</label>
        <input type="number" id="nbPasseurs" min="0" max="10">
        <div id="passeurs-container"></div>
    </div>

    <button onclick="soumettreMatch()">Enregistrer le match</button>
    <p id="resultatMessage"></p>

    <br><br>
    <hr>
    <h2>Matchs enregistr√©s</h2>
    <table id="tableMatchs" border="1" cellpadding="5" style="width: 100%; margin-top: 20px;">
        <thead>
            <tr>
                <th>Date</th>
                <th>√âquipe</th>
                <th>Adversaire</th>
                <th>Lieu</th>
                <th>Comp√©tition</th>
                <th>Buts GJPB</th>
                <th>Buts Adv.</th>
                <th>R√©sultat</th>
                <th>Modifier</th>
                <th>Supprimer</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const SUPABASE_URL = 'https://lgnwgbctaqaeawzjnuqh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbndnYmN0YXFhZWF3empudXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjYzNjUsImV4cCI6MjA2OTQwMjM2NX0.E0ug5jpRQVh55aq1ewToqol7h7aRPkg7YvwbKpQtVHo';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let joueurs = [];
        let matchEnCours = null; // Stocke l'id du match √† modifier


        document.addEventListener("DOMContentLoaded", async () => {
            const { data, error } = await supabase.from('joueurs').select('nom');
            if (error) {
                document.getElementById("resultatMessage").innerText = "Erreur chargement joueurs.";
                return;
            }
            joueurs = data.map(j => j.nom);

            document.getElementById('nbButeurs').addEventListener('change', () => genererChamps('buteurs-container', 'buteur'));
            document.getElementById('nbPasseurs').addEventListener('change', () => genererChamps('passeurs-container', 'passeur'));

            chargerMatchs();
        });

        function genererChamps(containerId, prefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const nb = document.getElementById(`nb${prefix[0].toUpperCase() + prefix.slice(1)}s`).value;

            for (let i = 0; i < nb; i++) {
                const select = document.createElement('select');
                select.name = `${prefix}_${i}`;
                joueurs.forEach(nom => {
                    const option = document.createElement('option');
                    option.value = nom;
                    option.textContent = nom;
                    select.appendChild(option);
                });
                container.appendChild(select);
            }
        }

        async function soumettreMatch() {
            const match = {
                date: document.getElementById('date').value,
                equipe: document.getElementById('equipe').value,
                adversaire: document.getElementById('adversaire').value,
                lieu: document.getElementById('lieu').value,
                competition: document.getElementById('competition').value,
                buts_gjpb: parseInt(document.getElementById('buts_gjpb').value),
                buts_adv: parseInt(document.getElementById('buts_adv').value),
                resultat: document.getElementById('resultat').value,
            };

            let error;

            if (matchEnCours) {
                // MODIFICATION
                ({ error } = await supabase
                    .from("matchs")
                    .update(match)
                    .eq("id", matchEnCours));
            } else {
                // AJOUT
                ({ error } = await supabase
                    .from("matchs")
                    .insert(match));
            }

            if (error) {
                alert("Erreur lors de l'enregistrement");
                console.error(error);
                return;
            }

            // Reset formulaire
            document.querySelector("button[onclick='soumettreMatch()']").innerText = "Enregistrer le match";
            document.querySelector("form")?.reset(); // ou vider les champs un √† un
            matchEnCours = null;

            // Recharge la liste
            chargerMatchs();
        }



        // async function soumettreMatch() {
        //     const date = document.getElementById('date').value;
        //     const equipe = document.getElementById('equipe').value;
        //     const adversaire = document.getElementById('adversaire').value;
        //     const lieu = document.getElementById('lieu').value;
        //     const competition = document.getElementById('competition').value;
        //     const buts_gjpb = parseInt(document.getElementById('buts_gjpb').value);
        //     const buts_adv = parseInt(document.getElementById('buts_adv').value);
        //     const resultat = document.getElementById('resultat').value;

        //     // 1. Ins√©rer le match
        //     const { data: matchData, error: matchError } = await supabase.from('matchs').insert({
        //         date, equipe, adversaire, lieu, competition, buts_gjpb, buts_adv, resultat
        //     }).select().single();

        //     if (matchError) {
        //         document.getElementById("resultatMessage").innerText = "‚ùå Erreur ajout match.";
        //         console.error(matchError);
        //         return;
        //     }

        //     const match_id = matchData.id;

        //     // 2. R√©cup√©rer les buteurs
        //     const nbButeurs = parseInt(document.getElementById('nbButeurs').value) || 0;
        //     const buteursContainer = document.getElementById('buteurs-container');
        //     const actions = [];

        //     for (let i = 0; i < nbButeurs; i++) {
        //         const nom = buteursContainer.querySelectorAll('select')[i].value;
        //         actions.push({ match_id, joueur: nom, type: 'Goal' });
        //     }

        //     // 3. R√©cup√©rer les passeurs
        //     const nbPasseurs = parseInt(document.getElementById('nbPasseurs').value) || 0;
        //     const passeursContainer = document.getElementById('passeurs-container');

        //     for (let i = 0; i < nbPasseurs; i++) {
        //         const nom = passeursContainer.querySelectorAll('select')[i].value;
        //         actions.push({ match_id, joueur: nom, type: 'Assist' });
        //     }

        //     // 4. Enregistrer les actions
        //     const { error: actionsError } = await supabase.from('actions').insert(actions);

        //     if (actionsError) {
        //         document.getElementById("resultatMessage").innerText = "‚ùå Match OK mais erreur sur actions.";
        //         console.error(actionsError);
        //         return;
        //     }

        //     // 5. Succ√®s
        //     document.getElementById("resultatMessage").innerText = "‚úÖ Match et actions enregistr√©s avec succ√®s !";
        //     document.getElementById("resultatMessage").style.color = "green";
        // }

        async function chargerMatchs() {
            const { data, error } = await supabase.from("matchs").select("*").order("date", { ascending: false });

            console.log("MATCHS :", data, error);

            if (error) {
                console.error("Erreur chargement matchs :", error.message);
                return;
            }

            const tbody = document.querySelector("#tableMatchs tbody");
            tbody.innerHTML = ""; // reset

            data.forEach(match => {
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${match.date}</td>
                <td>${match.equipe}</td>
                <td>${match.adversaire}</td>
                <td>${match.lieu}</td>
                <td>${match.competition}</td>
                <td>${match.buts_gjpb}</td>
                <td>${match.buts_adv}</td>
                <td>${match.resultat}</td>
                <td><button onclick="modifierMatch('${match.id}')">‚úèÔ∏è</button></td>
                <td><button onclick="supprimerMatch('${match.id}')">üóëÔ∏è</button></td>
                `;

                tbody.appendChild(row);
            });
        }

        async function supprimerMatch(id) {
            const confirmation = confirm("Supprimer ce match ?");
            if (!confirmation) return;

            const { error } = await supabase
                .from("matchs")
                .delete()
                .eq("id", id);

            if (error) {
                alert("Erreur lors de la suppression");
                console.error(error);
            } else {
                chargerMatchs(); // Recharge la liste
            }
        }

        async function modifierMatch(id) {
            const { data, error } = await supabase.from('matchs').select('*').eq('id', id).single();

            if (error) {
                alert("Erreur lors du chargement du match √† modifier");
                console.error(error);
                return;
            }

            // Pr√©-remplir le formulaire
            document.getElementById('date').value = data.date;
            document.getElementById('equipe').value = data.equipe;
            document.getElementById('adversaire').value = data.adversaire;
            document.getElementById('lieu').value = data.lieu;
            document.getElementById('competition').value = data.competition;
            document.getElementById('buts_gjpb').value = data.buts_gjpb;
            document.getElementById('buts_adv').value = data.buts_adv;
            document.getElementById('resultat').value = data.resultat;

            // Indiquer qu'on est en mode modification
            matchEnCours = id;
            document.querySelector("button[onclick='soumettreMatch()']").innerText = "Modifier le match";
        }



    </script>


</body>

</html>